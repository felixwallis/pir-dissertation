---
title: "Climate Congressional Record and Climate Hansard Topic Modelling"
output: pdf_document
fontsize: 12pt
---

# Setup

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(janitor)
library(stringr)
library(quanteda)
library(stm)

DATA_PATH <- "data/"
DIST_PATH <- "dist/"

ELECTION_PERIOD_DAYS <- 60

climate_congressional_record <-
    read_csv(paste0(DATA_PATH, "climate_congressional_record.csv"))
climate_hansard <-
    read_csv(paste0(DATA_PATH, "climate_hansard.csv"))

election_dates <-
    read_csv(paste0(DATA_PATH, "election_dates_1997_2015.csv")) |>
    clean_names() |>
    mutate(
        date = as.character(date) |> as.Date(date, format = "%B %d, %Y")
    )
```

# Data preprocessing

## Cleaning the Climate Congressional Record dataset

```{r}
climate_congressional_record <- climate_congressional_record |>
    rename(
        family_name = last_name,
        speech_date = date,
        speech_party = party,
        text = speech
    ) |>
    mutate(
        across(c(first_name, family_name), str_to_title),
        name = paste(first_name, family_name, sep = " ") |> str_to_title(),
        speech_party = case_when(
            speech_party == "R" ~ "Republican",
            speech_party == "D" ~ "Democrat",
        ),
        speech_id = as.character(speech_id),
        chamber = case_when(
            chamber == "H" ~ "House",
            chamber == "S" ~ "Senate"
        )
    ) |>
    select(
        speech_id,
        name,
        first_name,
        family_name,
        speech_date,
        year,
        speech_party,
        text,
        cleaned_stems,
        chamber,
    ) |>
    mutate(country = "USA")
```

## Cleaning the Climate Hansard dataset

```{r}
climate_hansard <- climate_hansard |>
    select(
        speech_id,
        name,
        first_name,
        family_name,
        speech_date,
        speech_party,
        year,
        text,
        cleaned_stems
    ) |>
    mutate(
        chamber = "House of Commons",
        country = "UK"
    )
```

## Combining the Climate Congressional Record and Climate Hansard datasets

```{r}
complete_climate_speeches <- bind_rows(
    climate_congressional_record,
    climate_hansard
) |>
    arrange(speech_date) |>
    mutate(
        date_as_numeric = as.numeric(speech_date),
        affiliation = case_when(
            speech_party %in% c("Democrat", "Labour") ~ "Left",
            speech_party %in% c(
                "Republican", "Conservative"
            ) ~ "Right"
        )
    ) |>
    filter(year == 2015)
```

### Recording if a speech was made within 60 days of an election

```{r}
in_election_period <- function(row) {
    speech_date <- row$speech_date
    chamber <- row$chamber

    if (chamber == "House" | chamber == "Senate") {
        house_election_dates <- election_dates |>
            filter(election_type == "US Congressional") |>
            pull(date)
        return(
            any(abs(house_election_dates - speech_date) <= ELECTION_PERIOD_DAYS)
        )
    } else if (chamber == "House of Commons") {
        uk_election_dates <- election_dates |>
            filter(election_type == "UK General") |>
            pull(date)
        return(
            any(abs(uk_election_dates - speech_date) <= ELECTION_PERIOD_DAYS)
        )
    }
}

complete_climate_speeches <- complete_climate_speeches |>
    mutate(
        in_election_period = map_lgl(
            seq_len(nrow(complete_climate_speeches)),
            ~ in_election_period(complete_climate_speeches[.x, ])
        )
    )
```

## Creating a Climate Speeches dfm

```{r}
climate_speeches_corpus <-
    corpus(
        complete_climate_speeches,
        text_field = "cleaned_stems"
    )
climate_speeches_dfm <-
    climate_speeches_corpus |>
    tokens() |>
    dfm()
```

# Testing Hypothesis 2

## Using `searchK` to find the optimal number of topics for an STM with an interaction between `affiliation` and `country`, with `date_as_numeric` added as a covariate

```{r}
party_interaction_search_k <- searchK(
    documents = climate_speeches_dfm,
    K = c(10, 20, 50),
    prevalence = ~ affiliation * country + s(date_as_numeric),
    data = complete_climate_speeches,
    N = floor(0.1 * nrow(complete_climate_speeches)),
    cores = 6,
    verbose = TRUE
)
plot(party_interaction_search_k)
save(
    party_interaction_search_k,
    file = paste0(DATA_PATH, "party_interaction_search_k.RData")
)
```

# Testing Hypothesis 3

## Using `searchK` to find the optimal number of topics for an STM with an interaction betwwn `in_election_period` and `country`, with `date_as_numeric` added as a covariate

```{r}
election_interaction_search_k <- searchK(
    documents = climate_speeches_dfm,
    K = c(10, 20, 50),
    prevalence = ~ in_election_period * country + s(date_as_numeric),
    data = complete_climate_speeches,
    N = floor(0.1 * nrow(complete_climate_speeches)),
    cores = 6,
    verbose = TRUE
)
plot(election_interaction_search_k)
save(
    election_interaction_search_k,
    file = paste0(DATA_PATH, "election_interaction_search_k.RData")
)
```